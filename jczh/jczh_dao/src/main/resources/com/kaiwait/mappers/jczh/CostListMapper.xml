<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kaiwait.mappers.jczh.CostListMapper">
	<resultMap type="com.kaiwait.bean.jczh.vo.CostListVo" id="CostListVo">

	</resultMap>
	<sql id="baseSql">
select * from (
SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY as realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		c.COST_NO AS costno,
		IFNULL(c.INPUT_NO,"") AS inputno,
		"" AS oldinputno,
		c.PAYEE_CD AS paycd,
		c.COST_NAME AS `name`,
				"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		c.`STATUS` AS statuscd,
		ifnull( p.PAY_AMT, c.COST_RMB ) AS amt,
		ifnull( p.PAY_VAT_AMT, c.COST_VAT_AMT ) AS vatamt,
		ifnull( p.PAY_RMB, COST_PAY_AMT ) AS payamt,
		c.ADDDATE AS adddate,
		IFNULL( p.PAYREQDATE,"")  AS payreqdate,
		IFNULL( p.CONFIRMDATE,"")  AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		c.OUTPUT_FLG AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		p.PAY_FLG AS payflgcd,
		 IFNULL( p.LOCK_FLG,"")  AS paylockflg,
		ifnull( payinvoice.INVOICE_NO, invoiceintrn.INVOICE_NO ) AS invoicno,
		ifnull( payinvoice.INVOICE_DATE, ifnull(invoiceintrn.INVOICE_DATE,"")) AS invoicedate,
		ifnull( p.ADDUSERCD, c.ADDUSERCD ) AS addusercd,
		 ucad.USER_NAME AS addusername,
		ifnull( p.PAYREQEMP,"") AS payreqemp,
		ifnull( ureq.USER_NAME,"")   AS payreqempname,
		ifnull( p.CONFIRMEMP,"")  AS confirmemp,
		ifnull(  ucfm.USER_NAME,"") AS confirmempname,
		ifnull(p.PAY_DLYDAY,"")  AS paydlyday,
		ifnull(c.PLAN_DLVDAY ,"")  AS plandlvday,
		 ifnull(p.PAY_HOPE_DATE,"") AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		c.COST_REMARK AS remark,
		c.COST_TYPE AS costtype,
		ifnull(p.PAY_DATE,"") AS paydate,
		ifnull(p.PAY_PLAN_DATE,"") AS planpaydate,
		ifnull(col.lable,"") AS lable,
		ifnull(col.lableid,"") AS lableid,
		ifnull(col.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		cl2.DIVNM AS payeename,
		 ifnull(cl2.DIVNAME_FULL,"")  AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		ifnull(reqMst.USERCD,"")   AS requsercd,
		IFNULL(mdMst.USERCD,"") AS mdusercd,
	 IFNULL(p.PAY_REMARK,"") 	 AS payremark 
from	jobtrn as j
	join costtrn as c on j.JOB_CD = c.JOB_CD and c.DEL_FLG = 0 and c.COMPANY_CD = #{companycd}
	left join paytrn as p on c.INPUT_NO = p.INPUT_NO and p.DEL_FLG = 0 and p.COMPANY_CD = #{companycd}
	left join clmst as cl1 on j.CLDIV_CD = cl1.CLDIVCD and cl1.COMPANY_CD= #{companycd} and  cl1.CLIENT_FLG = 1
	left join clmst as cl2 on cl2.CLDIVCD = c.PAYEE_CD and cl2.COMPANY_CD= #{companycd} AND cl2.CONTRA_FLG = 1
	left join invoiceintrn on invoiceintrn.COST_NO = c.COST_NO and invoiceintrn.DEL_FLG = 0 and invoiceintrn.COMPANY_CD = #{companycd}
	left join invoiceintrn as payinvoice on payinvoice.COST_NO = p.INPUT_NO and payinvoice.DEL_FLG = 0 and payinvoice.COMPANY_CD = #{companycd}
	<!-- left join orderlabeltrn on orderlabeltrn.COST_NO = c.COST_NO  and orderlabeltrn.COMPANY_CD = #{companycd} and orderlabeltrn.LABEL_LEVEL = 0
	left join labelmst as lb on lb.LABEL_ID = orderlabeltrn.LABEL_ID and lb.COMPANY_CD = #{companycd} and lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	left join sellordertrn on sellordertrn.JOB_CD = j.JOB_CD and sellordertrn.COMPANY_CD = #{companycd} and sellordertrn.DEL_FLG = 0
    left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "001" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
    left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd}
    left join usermst upad on upad.USERCD = p.ADDUSERCD 
	left join usermst ucad on ucad.USERCD = c.ADDUSERCD  
	left join usermst ucfm on ucfm.USERCD = p.CONFIRMEMP  
	left join usermst ureq on ureq.USERCD = p.PAYREQEMP   
	  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD  
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD  

    LEFT JOIN
(
 SELECT
	c.JOB_CD as jobcd,
    c.COST_NO as costno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	costtrn c
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = c.COST_NO
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND (orderlabeltrn.LABEL_LEVEL = 0 or orderlabeltrn.LABEL_LEVEL = 1)
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,costno


) col on col.costno =  c.COST_NO
   where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
group by j.JOB_CD,c.COST_NO
<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
union all 
 SELECT
	b.ITEMNAME_JP AS lendnamejp,
		b.ITEMNAME_EN AS lendnameen,
		b.ITEMNAME_HK AS lendnamezt,
		b.ITMNAME AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY as realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS cost_no,
		IFNULL(l.NEW_INPUT_NO,"")  AS inputno,
		l.INPUT_NO AS oldinputno,
		"" AS paycd,
		l.LEND_NAME AS `name`,
				"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		l.`STATUS` AS statuscd,
		l.LEND_AMT AS amt,
		l.LEND_VAT_AMT AS vatamt,
		l.LEND_PAY_AMT AS payamt,
		l.ADDDATE AS adddate,
		"" AS payreqdate,
		 IFNULL( l.CONFIRMDATE,"")  AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		l.ADDUSERCD AS addusercd,
		lad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		l.CONFIRMEMP AS confirmemp,
		lcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS pay_hopedate,
		l.LEND_DATE AS lenddate,
		usermst.USER_NAME AS lenduser,
		l.LEND_NAME AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		l.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		 IFNULL(lol.lable,"") AS lable,
		IFNULL(lol.lableid,"") AS lableid,
		IFNULL(lol.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		 ifnull(cl2.DIVNAME_FULL,"")  AS payeefullname,
		l.BL_FLG AS bl,
		adMst.USERCD AS adusercd,
		  ifnull(reqMst.USERCD,"")   AS requsercd,
		IFNULL(mdMst.USERCD,"") AS mdusercd,
		"" AS payremark 
FROM
	jobtrn j
	JOIN lendtrn l ON l.JOB_CD = j.JOB_CD and  l.COMPANY_CD =#{companycd} and l.DEL_FLG = 0
	LEFT JOIN commonmst b ON l.ITEM_CODE = b.ITEMCD AND b.mstcd = '9001' AND b.company_cd = #{companycd}
	LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD   and cl1.COMPANY_CD =#{companycd} AND cl1.CLIENT_FLG = 1
	LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD  and cl2.COMPANY_CD =#{companycd} AND cl2.CONTRA_FLG = 1
	<!-- LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = l.INPUT_NO  AND orderlabeltrn.COMPANY_CD = #{companycd} AND orderlabeltrn.LABEL_LEVEL = 2
	LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID AND lb.COMPANY_CD = #{companycd} AND lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD AND sellordertrn.DEL_FLG = 0 and sellordertrn.COMPANY_CD = #{companycd}
  left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "002" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
	 left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd} 
	  left join usermst on l.LEND_USER = usermst.USERCD  
	  
	   left join usermst lcfm on lcfm.USERCD = l.CONFIRMEMP  
left join usermst lad on lad.USERCD = l.ADDUSERCD 

  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD  
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD
    
        LEFT JOIN
(
 SELECT
	l.JOB_CD as jobcd,
    l.INPUT_NO as inputno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	lendtrn l
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = l.INPUT_NO
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND orderlabeltrn.LABEL_LEVEL = 2
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,inputno


) lol on lol.inputno =  l.INPUT_NO
    
    
	 where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
GROUP BY
	j.JOB_CD,
	l.INPUT_NO
<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
union all 
SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY as realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS costno,
		IFNULL(t.NEW_INPUT_NO,"")   AS inputno,
		t.INPUT_NO AS oldinputno,
		"" AS paycd,
		t.TRAN_NAME AS `name`,
				"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		t.TRAN_STATUS AS statuscd,
		t.TRAN_AMT AS amt,
		"" AS vatamt,
		"" AS payamt,
		t.ADD_DATE AS adddate,
		"" AS payreqdate,
		IFNULL(t.CONFIRMDATE,"") AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		t.ADD_USERCD AS addusercd,
		tad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		t.CONFIRMEMP AS confirmemp,
		tcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		co.AIDCD AS tranitemcode,
		co.ITMNAME AS tranitemnamezc,
		co.ITEMNAME_EN AS tranitemnameen,
		co.ITEMNAME_JP AS tranitemnamejp,
		co.ITEMNAME_HK AS tranitemnamezt,
		t.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		  IFNULL(tol.lable,"") AS lable,
		IFNULL(tol.lableid,"") AS lableid,
		IFNULL(tol.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		 IFNULL(cl2.DIVNAME_FULL,"") AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		  ifnull(reqMst.USERCD,"")  AS requsercd,
		 IFNULL(mdMst.USERCD,"") AS mdusercd,
		"" AS payremark 
FROM
	jobtrn j
	JOIN trantrn t ON j.JOB_CD = t.JOB_CD AND t.COMPANY_CD = #{companycd} AND j.DEL_FLG = 0 and  t.DEL_FLG = 0
	LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD AND cl1.CLIENT_FLG = 1 AND cl1.COMPANY_CD = #{companycd}
	LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD AND cl2.CONTRA_FLG = 1 AND cl2.COMPANY_CD = #{companycd} 
	<!-- LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = t.INPUT_NO AND orderlabeltrn.COMPANY_CD = #{companycd} AND orderlabeltrn.LABEL_LEVEL = 3
	LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID AND lb.COMPANY_CD = #{companycd} AND lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD AND sellordertrn.DEL_FLG = 0 AND sellordertrn.COMPANY_CD = #{companycd}
  left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "003" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
  left join commonmst co on co.MSTCD = "9002" and co.ITEMCD= t.ITEM_CODE and  co.COMPANY_CD  = #{companycd} and co.DEL_FLG = 0
	 left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd}
	  left join usermst tcfm on tcfm.USERCD = t.CONFIRMEMP
left join usermst tad on tad.USERCD = t.ADD_USERCD 

  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD 
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD  

      LEFT JOIN
(
 SELECT
	t.JOB_CD as jobcd,
    t.INPUT_NO as inputno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	trantrn t
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = t.INPUT_NO
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND orderlabeltrn.LABEL_LEVEL = 3
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,inputno



) tol on tol.inputno =  t.INPUT_NO


	 where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
GROUP BY
	j.JOB_CD,
	t.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
) a 
where 1=1
  <if test="all==null or all==''">
  and (
  	<trim prefixOverrides="and |or">
   <if test="cldivUser!=null or cldivUser!=''">
      a.cldivcd in (
        	select ucl.cldivcd 
			from userclmst ucl 
			where ucl.user_cd =#{cldivUser}
			and ucl.company_cd=#{companycd}
      )
   </if>
   <if test="adUser!=null or adUser!=''">
      or a.adusercd = #{adUser} or a.requsercd = #{adUser}
   </if>
    <if test="mdUser!=null or mdUser!=''">
      or a.mdusercd = #{mdUser} 
   </if>
   </trim >
  )
  </if> 
 
	</sql>
	<!-- 详细基本检索 -->
	<select id="getCostList" resultType="com.kaiwait.bean.jczh.vo.CostListVo">
	select * from (
	SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		c.COST_NO AS costno,
		IFNULL(c.INPUT_NO,"") AS inputno,
		"" AS oldinputno,
		c.PAYEE_CD AS paycd,
		c.COST_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		c.`STATUS` AS statuscd,
		ifnull( p.PAY_AMT, c.COST_RMB ) AS amt,
		ifnull( p.PAY_VAT_AMT, c.COST_VAT_AMT ) AS vatamt,
		ifnull( p.PAY_RMB, COST_PAY_AMT ) AS payamt,
		 c.ADDDATE  AS adddate,
		IFNULL( p.PAYREQDATE,"")  AS payreqdate,
		IFNULL( p.CONFIRMDATE,"")  AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		c.OUTPUT_FLG AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		p.PAY_FLG  AS payflgcd,
		IFNULL( p.LOCK_FLG,"")  AS paylockflg,
		ifnull( payinvoice.INVOICE_NO, invoiceintrn.INVOICE_NO ) AS invoicno,
		ifnull( payinvoice.INVOICE_DATE, ifnull(invoiceintrn.INVOICE_DATE,"")) AS invoicedate,
		ifnull( p.ADDUSERCD, c.ADDUSERCD ) AS addusercd,
		ucad.USER_NAME AS addusername,
		ifnull( p.PAYREQEMP,"") AS payreqemp,
		ifnull( ureq.USER_NAME,"")   AS payreqempname,
		ifnull( p.CONFIRMEMP,"")  AS confirmemp,
		ifnull(  ucfm.USER_NAME,"") AS confirmempname,
		ifnull(p.PAY_DLYDAY,"")  AS paydlyday,
		ifnull(c.PLAN_DLVDAY ,"")  AS plandlvday,
		 ifnull(p.PAY_HOPE_DATE,"") AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		c.COST_REMARK AS remark,
		c.COST_TYPE AS costtype,
		ifnull(p.PAY_DATE,"") AS paydate,
		ifnull(p.PAY_PLAN_DATE,"") AS planpaydate,
		ifnull(col.lable,"") AS lable,
		ifnull(col.lableid,"") AS lableid,
		ifnull(col.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		cl2.DIVNM AS payeename,
		 ifnull(cl2.DIVNAME_FULL,"")  AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		ifnull(reqMst.USERCD,"")   AS requsercd,
		IFNULL(mdMst.USERCD,"") AS mdusercd,
	 IFNULL(p.PAY_REMARK,"") 	 AS payremark 
from	jobtrn as j
	join costtrn as c on j.JOB_CD = c.JOB_CD and c.DEL_FLG = 0 and c.COMPANY_CD = #{companycd}
	left join paytrn as p on c.INPUT_NO = p.INPUT_NO and p.DEL_FLG = 0 and p.COMPANY_CD = #{companycd}
	left join clmst as cl1 on j.CLDIV_CD = cl1.CLDIVCD and cl1.COMPANY_CD= #{companycd} and  cl1.CLIENT_FLG = 1
	left join clmst as cl2 on cl2.CLDIVCD = c.PAYEE_CD and cl2.COMPANY_CD= #{companycd} AND cl2.CONTRA_FLG = 1
	left join invoiceintrn on invoiceintrn.COST_NO = c.COST_NO and invoiceintrn.DEL_FLG = 0 and invoiceintrn.COMPANY_CD = #{companycd}
	left join invoiceintrn as payinvoice on payinvoice.COST_NO = p.INPUT_NO and payinvoice.DEL_FLG = 0 and payinvoice.COMPANY_CD = #{companycd}
	<!-- left join orderlabeltrn on orderlabeltrn.COST_NO = c.COST_NO  and orderlabeltrn.COMPANY_CD = #{companycd} and orderlabeltrn.LABEL_LEVEL = 0
	left join labelmst as lb on lb.LABEL_ID = orderlabeltrn.LABEL_ID and lb.COMPANY_CD = #{companycd} and lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	left join sellordertrn on sellordertrn.JOB_CD = j.JOB_CD and sellordertrn.COMPANY_CD = #{companycd} and sellordertrn.DEL_FLG = 0
    left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "001" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
    left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd} 
    left join usermst upad on upad.USERCD = p.ADDUSERCD 
	left join usermst ucad on ucad.USERCD = c.ADDUSERCD  
	left join usermst ucfm on ucfm.USERCD = p.CONFIRMEMP  
	left join usermst ureq on ureq.USERCD = p.PAYREQEMP   
	  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD  
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD  

    LEFT JOIN
(
 SELECT
	c.JOB_CD as jobcd,
    c.COST_NO as costno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	costtrn c
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = c.COST_NO
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND (orderlabeltrn.LABEL_LEVEL = 0 or orderlabeltrn.LABEL_LEVEL = 1)
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,costno


) col on col.costno =  c.COST_NO
   where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
group by j.JOB_CD,c.COST_NO
<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>

union all 
 SELECT
		b.ITEMNAME_JP AS lendnamejp,
		b.ITEMNAME_EN AS lendnameen,
		b.ITEMNAME_HK AS lendnamezt,
		b.ITMNAME AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS cost_no,
		IFNULL(l.NEW_INPUT_NO,"")  AS inputno,
		l.INPUT_NO AS oldinputno,
		"" AS paycd,
		l.LEND_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		l.`STATUS` AS statuscd,
		l.LEND_AMT AS amt,
		l.LEND_VAT_AMT AS vatamt,
		l.LEND_PAY_AMT AS payamt,
		l.ADDDATE AS adddate,
		"" AS payreqdate,
		 IFNULL( l.CONFIRMDATE,"")  AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		l.ADDUSERCD AS addusercd,
		lad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		l.CONFIRMEMP AS confirmemp,
		lcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS pay_hopedate,
		l.LEND_DATE AS lenddate,
		usermst.USER_NAME AS lenduser,
		l.LEND_NAME AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		l.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		 IFNULL(lol.lable,"") AS lable,
		IFNULL(lol.lableid,"") AS lableid,
		IFNULL(lol.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		 ifnull(cl2.DIVNAME_FULL,"")  AS payeefullname,
		l.BL_FLG AS bl,
		adMst.USERCD AS adusercd,
		  ifnull(reqMst.USERCD,"")   AS requsercd,
		IFNULL(mdMst.USERCD,"") AS mdusercd,
		"" AS payremark 
FROM
	jobtrn j
	JOIN lendtrn l ON l.JOB_CD = j.JOB_CD and  l.COMPANY_CD =#{companycd} and l.DEL_FLG = 0
	LEFT JOIN commonmst b ON l.ITEM_CODE = b.ITEMCD AND b.mstcd = '9001' AND b.company_cd = #{companycd}
	LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD   and cl1.COMPANY_CD =#{companycd} AND cl1.CLIENT_FLG = 1
	LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD  and cl2.COMPANY_CD =#{companycd} AND cl2.CONTRA_FLG = 1
	<!-- LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = l.INPUT_NO  AND orderlabeltrn.COMPANY_CD = #{companycd} AND orderlabeltrn.LABEL_LEVEL = 2
	LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID AND lb.COMPANY_CD = #{companycd} AND lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD AND sellordertrn.DEL_FLG = 0 and sellordertrn.COMPANY_CD = #{companycd}
  left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "002" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
	 left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd}
	  left join usermst on l.LEND_USER = usermst.USERCD  
	  
	   left join usermst lcfm on lcfm.USERCD = l.CONFIRMEMP  
left join usermst lad on lad.USERCD = l.ADDUSERCD 

  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD  
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD
    
        LEFT JOIN
(
 SELECT
	l.JOB_CD as jobcd,
    l.INPUT_NO as inputno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	lendtrn l
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = l.INPUT_NO 
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND orderlabeltrn.LABEL_LEVEL = 2
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,inputno


) lol on lol.inputno =  l.INPUT_NO
    
    
	 where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
GROUP BY
	j.JOB_CD,
	l.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
union all 
SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS costno,
		IFNULL(t.NEW_INPUT_NO,"")   AS inputno,
		t.INPUT_NO AS oldinputno,
		"" AS paycd,
		t.TRAN_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		t.TRAN_STATUS AS statuscd,
		t.TRAN_AMT AS amt,
		"" AS vatamt,
		"" AS payamt,
		t.ADD_DATE AS adddate,
		"" AS payreqdate,
		IFNULL(t.CONFIRMDATE,"") AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		t.ADD_USERCD AS addusercd,
		tad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		t.CONFIRMEMP AS confirmemp,
		tcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		co.AIDCD AS tranitemcode,
		co.ITMNAME AS tranitemnamezc,
		co.ITEMNAME_EN AS tranitemnameen,
		co.ITEMNAME_JP AS tranitemnamejp,
		co.ITEMNAME_HK AS tranitemnamezt,
		t.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		  IFNULL(tol.lable,"") AS lable,
		IFNULL(tol.lableid,"") AS lableid,
		IFNULL(tol.lablelevel,"") AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		 IFNULL(cl2.DIVNAME_FULL,"") AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		  ifnull(reqMst.USERCD,"")  AS requsercd,
		 IFNULL(mdMst.USERCD,"") AS mdusercd,
		"" AS payremark
FROM
	jobtrn j
	JOIN trantrn t ON j.JOB_CD = t.JOB_CD AND t.COMPANY_CD = #{companycd} AND j.DEL_FLG = 0 and  t.DEL_FLG = 0
	LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD AND cl1.CLIENT_FLG = 1 AND cl1.COMPANY_CD = #{companycd}
	LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD AND cl2.CONTRA_FLG = 1 AND cl2.COMPANY_CD = #{companycd} 
	<!-- LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = t.INPUT_NO AND orderlabeltrn.COMPANY_CD = #{companycd} AND orderlabeltrn.LABEL_LEVEL = 3
	LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID AND lb.COMPANY_CD = #{companycd} AND lb.LABEL_TYPE = 1 and lb.DEL_FLG=0 -->
	LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD AND sellordertrn.DEL_FLG = 0 AND sellordertrn.COMPANY_CD = #{companycd}
  left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "003" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
  left join commonmst co on co.MSTCD = "9002" and co.ITEMCD= t.ITEM_CODE and  co.COMPANY_CD  = #{companycd} and co.DEL_FLG = 0
	 left join salemst on j.SALE_TYP = salemst.SALE_CD and salemst.COMPANY_CD = #{companycd}
	  left join usermst tcfm on tcfm.USERCD = t.CONFIRMEMP
left join usermst tad on tad.USERCD = t.ADD_USERCD 

  <!-- 关联权限 --><!--  责任者的关联条件 -->
    left join jobuserstrn jobAduser
    on j.JOB_CD = jobAduser.JOB_CD and jobAduser.LEVEL_FLG = '1' and jobAduser.COMPANY_CD = #{companycd} and jobAduser.DEL_FLG = 0
    left join usermst adMst 
    on adMst.USERCD = jobAduser.USERCD 
     <!-- 关联权限 --><!--  担当者的关联条件 -->
    left join jobuserstrn jobRequser
    on j.JOB_CD = jobRequser.JOB_CD and jobRequser.LEVEL_FLG = '2' and jobRequser.COMPANY_CD = #{companycd} and jobRequser.DEL_FLG = 0
    left join usermst reqMst 
    on reqMst.USERCD = jobRequser.USERCD 
     <!-- 关联权限 --><!--  md的关联条件 -->
     left join jobuserstrn jobMduser
    on j.JOB_CD = jobMduser.JOB_CD and jobMduser.LEVEL_FLG = '3' and jobMduser.COMPANY_CD = #{companycd} and jobMduser.DEL_FLG = 0
    left join usermst mdMst 
    on mdMst.USERCD = jobMduser.USERCD  

      LEFT JOIN
(
 SELECT
	t.JOB_CD as jobcd,
    t.INPUT_NO as inputno,
    GROUP_CONCAT(lb.LABEL_TEXT order by lb.LABEL_LEVEL desc separator '  ') as lable,
	GROUP_CONCAT(lb.LABEL_ID order by lb.LABEL_LEVEL desc separator '  ') as lableid,
	GROUP_CONCAT(lb.LABEL_LEVEL order by lb.LABEL_LEVEL desc separator '  ') as lablelevel
FROM
	trantrn t
LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = t.INPUT_NO
AND orderlabeltrn.COMPANY_CD = #{companycd}
AND orderlabeltrn.LABEL_LEVEL = 3
LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID
AND lb.COMPANY_CD = #{companycd}
AND lb.LABEL_TYPE = 1
AND lb.DEL_FLG = 0
GROUP BY jobcd,inputno


) tol on tol.inputno =  t.INPUT_NO


	 where j.COMPANY_CD = #{companycd} and j.DEL_FLG = 0
GROUP BY
	j.JOB_CD,
	t.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
) a 
where 1=1
  <if test="all==null or all==''">
  and (
  	<trim prefixOverrides="and |or">
   <if test="cldivUser!=null or cldivUser!=''">
      a.cldivcd in (
        	select ucl.cldivcd 
			from userclmst ucl 
			where ucl.user_cd =#{cldivUser}
			and ucl.company_cd=#{companycd}
      )
   </if>
   <if test="adUser!=null or adUser!=''">
      or a.adusercd = #{adUser} or a.requsercd = #{adUser}
   </if>
    <if test="mdUser!=null or mdUser!=''">
      or a.mdusercd = #{mdUser} 
   </if>
   </trim >
  )
  </if> 
       
		<if test="jobcd!=null and jobcd!=''">
			and a.jobcd like CONCAT('%',#{jobcd},'%')
		</if>
		<if test="cldivcd!=null and cldivcd!=''">
			and a.cldivcd= #{cldivcd}
		</if>
		<if test="cldivname!=null and cldivname!=''">
			and (a.cldivname like CONCAT('%',#{cldivname},'%') or a.cldivfullname like CONCAT('%',#{cldivname},'%'))
		</if>
		<if test="dalday!=null and dalday!=''">
		   <if test=" dalday1!=null and dalday1!=''">
		   and a.dalday between #{dalday} and #{dalday1}
		   </if>
		    <if test=" dalday1==null or dalday1==''">
		   and a.dalday &gt;= #{dalday} 
		   </if>
		</if>
		<if test="dalday==null or dalday1!=''">
		    <if test="dalday1!=null and dalday1!=''">
		         and a.dalday &lt;=  #{dalday1} 
		    </if>
		</if>
		<if test="dalmon!=null and dalmon!=''">
		    and date_format(a.dalday,'%Y-%m') = #{dalmon}
		</if>
		<if test="discd!=null and discd!=''">
			and a.discd = #{discd}
		</if>
		<if test="inputno!=null and inputno!=''">
			and a.inputno like CONCAT('%',#{inputno},'%')
		</if>
		<if test="paycd!=null and paycd!=''">
			and a.paycd =#{paycd}
		</if>
		<if test="payeename!=null and payeename!=''">
			and (a.payeename like CONCAT('%',#{payeename},'%') or a.payeefullname like CONCAT('%',#{payeename},'%'))
		</if>
		<if test="name!=null and name!=''">
			and a.`name` like CONCAT('%',#{name},'%')
		</if>
		<if test="costno!=null and costno!=''">
			and a.costno like CONCAT('%',#{costno},'%')
		</if>
		<if test="status!=null and status!=''">
		 <choose>
		 <!-- 进行中 -->
		   <when test="status==001">
		    <if test="discd==001">
		       and a.discd = "001" and a.statuscd != 4
		     </if>
		     <if test="discd==002">
		       and a.discd = "002" and a.statuscd != 3
		     </if>
		     <if test="discd==003">
		       and a.discd = "003" and a.statuscd != 2
		     </if>
		     <if test="discd==''||discd==null">
		       and ((a.discd = "001" and a.statuscd != 4) or ( a.discd = "002" and a.statuscd != 3) or ( a.discd = "003" and a.statuscd != 2))
		     </if>
		   </when>
		 <!-- 申请待 -->
		    <when test="status==002">
		     <!-- 支付登录完了 -->
		       and a.discd = "001" and a.statuscd = 1
		   </when>
		 <!-- 承认待 -->
		    <when test="status==003">
		       <!-- 支付申请完了 -->
		       <if test="discd==001">
		       and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "001" AND a.statuscd = 1 and (SELECT PAY_SKIP from companymst where company_cd= #{companycd})=1))
		       </if>
		        <if test="discd==002">
		       and a.discd = "002" and a.statuscd = 0
		       </if>
		        <if test="discd==003">
		      and a.discd = "003" and a.statuscd = 0
		       </if>
		       <if test="discd==''">
		        and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "002" and a.statuscd = 0) or ( a.discd = "003" and a.statuscd = 0) or (a.discd = "001" AND a.statuscd = 1 and (SELECT PAY_SKIP from companymst where company_cd= #{companycd})=1))
		       </if>
		   </when>
		 <!-- 承认济 -->
		    <when test="status==004">
		    		AND ((a.discd = "001" AND(a.statuscd = 3 OR a.statuscd = 4)) OR  (a.discd = '002' AND (a.statuscd = 1 OR a.statuscd = 3))
					OR  (a.discd = '003' AND (a.statuscd = 1 OR a.statuscd = 2)))
		   </when>
		<!-- 终了 -->
		    <when test="status==005">
		      <if test="discd==001">
		      and a.discd = "001" and a.statuscd = 4
		      </if>
		      <if test="discd==002">
		      and a.discd = "002" and a.statuscd = 3
		      </if>
		      <if test="discd==003">
		      and a.discd = "003" and a.statuscd = 2
		      </if>
		      <if test="discd==''">
		      and ((a.discd = "001" and a.statuscd = 4) or (a.discd = "002" and a.statuscd = 3) or (a.discd = "003" and a.statuscd = 2))
		      </if>
		      
		   </when>
	    <!-- 保留 -->
		    <when test="status==006">
		       and a.discd ="002" and   (a.statuscd = 2 or a.statuscd = 0) and a.bl =1
		   </when>
		 </choose>
		
		</if>
		<if test="paydlyday!=null and paydlyday!=''">
			and a.paydlyday = #{paydlyday}
		</if>
		<if test="lable!=null and lable!=''">
			and a.lable like CONCAT('%',#{lable},'%')
		</if>
		order by a.dalday asc, a.jobcd desc ,a.discd asc,a.costno desc,a.inputno desc
	</select>
<!-- 模糊查询 -->
	<select id="getCostListVogue" resultType="com.kaiwait.bean.jczh.vo.CostListVo">
		SELECT
	* 
FROM
	(
		SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY AS realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		j.COST_NO AS costno,
		IFNULL( j.INPUT_NO, "" ) AS inputno,
		"" AS oldinputno,
		j.PAYEE_CD AS paycd,
		j.COST_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		j.`STATUS` AS statuscd,
		ifnull( p.PAY_AMT, j.COST_RMB ) AS amt,
		ifnull( p.PAY_VAT_AMT, j.COST_VAT_AMT ) AS vatamt,
		ifnull( p.PAY_RMB, COST_PAY_AMT ) AS payamt,
		j.ADDDATE AS adddate,
		IFNULL( p.PAYREQDATE, "" ) AS payreqdate,
		IFNULL( p.CONFIRMDATE, "" ) AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		j.OUTPUT_FLG AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		p.PAY_FLG AS payflgcd,
		IFNULL( p.LOCK_FLG, "" ) AS paylockflg,
		ifnull( payinvoice.INVOICE_NO, invoiceintrn.INVOICE_NO ) AS invoicno,
		ifnull( payinvoice.INVOICE_DATE, ifnull( invoiceintrn.INVOICE_DATE, "" ) ) AS invoicedate,
		ifnull( p.ADDUSERCD, j.ADDUSERCD ) AS addusercd,
		 ucad.USER_NAME  AS addusername,
		ifnull( p.PAYREQEMP, "" ) AS payreqemp,
		ifnull( ureq.USER_NAME, "" ) AS payreqempname,
		ifnull( p.CONFIRMEMP, "" ) AS confirmemp,
		ifnull( ucfm.USER_NAME, "" ) AS confirmempname,
		ifnull( p.PAY_DLYDAY, "" ) AS paydlyday,
		ifnull( j.PLAN_DLVDAY, "" ) AS plandlvday,
		ifnull( p.PAY_HOPE_DATE, "" ) AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		j.COST_REMARK AS remark,
		j.COST_TYPE AS costtype,
		ifnull( p.PAY_DATE, "" ) AS paydate,
		ifnull( p.PAY_PLAN_DATE, "" ) AS planpaydate,
		ifnull( j.lable, "" ) AS lable,
		ifnull( j.lableid, "" ) AS lableid,
		ifnull( j.lablelevel, "" ) AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		cl2.DIVNM AS payeename,
		ifnull( cl2.DIVNAME_FULL, "" ) AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd,
		IFNULL( p.PAY_REMARK, "" ) AS payremark 
		FROM
	(
SELECT
		j.JOB_CD,
		j.JOB_NAME,
		j.CLDIV_CD,
		j.SALE_TYP,
		j.JOBEND_FLG,
		j.ACCOUNT_FLG,
		j.PLAN_DALDAY,
		j.PLAN_SALE,
		
		c.ADDDATE,
		c.ADDUSERCD,
		c.COST_NO,
		c.INPUT_NO,
		c.PAYEE_CD,
		c.COST_NAME,
		c.`STATUS`,
		c.OUTPUT_FLG,
		ifnull( c.PLAN_DLVDAY, "" ),
		c.COST_REMARK,
		c.COST_TYPE,
		c.COST_RMB,
		c.COST_VAT_AMT,
		c.COST_PAY_AMT,
		c.PLAN_DLVDAY,
		GROUP_CONCAT( lb.LABEL_TEXT ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lable,
		GROUP_CONCAT( lb.LABEL_ID ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lableid,
		GROUP_CONCAT( lb.LABEL_LEVEL ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lablelevel,
		j.COMPANY_CD
	FROM
	jobtrn j 
			JOIN costtrn AS c 
			ON j.JOB_CD = c.JOB_CD 
			AND c.DEL_FLG = 0 
			AND c.COMPANY_CD = #{companycd}
			AND j.DEL_FLG = 0 
			AND j.COMPANY_CD = #{companycd}
			LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = c.COST_NO 
			AND orderlabeltrn.COMPANY_CD = #{companycd} 
			AND ( orderlabeltrn.LABEL_LEVEL = 0 OR orderlabeltrn.LABEL_LEVEL = 1 )
			LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID 
			AND lb.COMPANY_CD = #{companycd} 
			AND lb.LABEL_TYPE = 1 
			AND lb.DEL_FLG = 0 
		WHERE
		1 = 1 
		AND j.COMPANY_CD = #{companycd} 
		AND c.COMPANY_CD = #{companycd}
		<if test="str!=null and str!=''">
		AND 
		(
			    c.COST_NAME LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	c.COST_REMARK LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	c.JOB_CD LIKE CONCAT( '%',#{str}, '%' )
		 OR lb.LABEL_TEXT LIKE CONCAT( '%',#{str}, '%' ) 
		)
		</if>
			GROUP BY
			j.JOB_CD,
			COST_NO 
			) AS j
		LEFT JOIN paytrn AS p ON j.INPUT_NO = p.INPUT_NO 
		AND p.DEL_FLG = 0 
		AND p.COMPANY_CD = #{companycd}
		LEFT JOIN clmst AS cl1 ON j.CLDIV_CD = cl1.CLDIVCD 
		AND cl1.COMPANY_CD = #{companycd} 
		AND cl1.CLIENT_FLG = 1
		LEFT JOIN clmst AS cl2 ON cl2.CLDIVCD = j.PAYEE_CD 
		AND cl2.COMPANY_CD = #{companycd} 
		AND cl2.CONTRA_FLG = 1
		LEFT JOIN invoiceintrn ON invoiceintrn.COST_NO = j.COST_NO 
		AND invoiceintrn.DEL_FLG = 0 
		AND invoiceintrn.COMPANY_CD = #{companycd}
		LEFT JOIN invoiceintrn AS payinvoice ON payinvoice.COST_NO = p.INPUT_NO 
		AND payinvoice.DEL_FLG = 0 
		AND payinvoice.COMPANY_CD = #{companycd}
		LEFT JOIN sellordertrn ON sellordertrn.JOB_CD = j.JOB_CD 
		AND sellordertrn.COMPANY_CD = #{companycd} 
		AND sellordertrn.DEL_FLG = 0
		LEFT JOIN commonmst ON commonmst.MSTCD = "0003" 
		AND commonmst.ITEMCD = "001" 
		AND commonmst.COMPANY_CD = #{companycd} 
		AND commonmst.DEL_FLG = 0
		LEFT JOIN salemst ON j.SALE_TYP = salemst.SALE_CD 
		AND salemst.COMPANY_CD = #{companycd}
		LEFT JOIN usermst upad ON upad.USERCD = p.ADDUSERCD
		LEFT JOIN usermst ucad ON ucad.USERCD = j.ADDUSERCD
		LEFT JOIN usermst ucfm ON ucfm.USERCD = p.CONFIRMEMP
		LEFT JOIN usermst ureq ON ureq.USERCD = p.PAYREQEMP
		LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
	GROUP BY
		j.JOB_CD,
		j.COST_NO
	UNION ALL
	SELECT
		"" AS lendnamejp,
		"" AS lendnameen,
		"" AS lendnamezt,
		"" AS lendnamezc,
		j.JOB_CD as jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY AS realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS costno,
		IFNULL( j.NEW_INPUT_NO, "" ) AS inputno,
		j.INPUT_NO AS oldinputno,
		"" AS paycd,
		j.TRAN_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		j.TRAN_STATUS AS statuscd,
		j.TRAN_AMT AS amt,
		"" AS vatamt,
		"" AS payamt,
		j.ADD_DATE AS adddate,
		"" AS payreqdate,
		IFNULL( j.CONFIRMDATE, "" ) AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		j.ADD_USERCD AS addusercd,
		tad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		j.CONFIRMEMP AS confirmemp,
		tcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS payhopedate,
		"" AS lenddate,
		"" AS lenduser,
		"" AS lendname,
		co.AIDCD AS tranitemcode,
		co.ITMNAME AS tranitemnamezc,
		co.ITEMNAME_EN AS tranitemnameen,
		co.ITEMNAME_JP AS tranitemnamejp,
		co.ITEMNAME_HK AS tranitemnamezt,
		j.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		IFNULL( cl2.DIVNAME_FULL, "" ) AS payeefullname,
		"" AS bl,
		adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd,
		"" AS payremark,
			IFNULL( j.lable, "" ) AS lable,
		IFNULL( j.lableid, "" ) AS lableid,
		IFNULL( j.lablelevel, "" ) AS lablelevel
	FROM
	(
SELECT
		j.JOB_CD,
		j.JOB_NAME, 
		j.CLDIV_CD, 
		j.SALE_TYP, 
				"" AS jobendflg,
		j.JOBEND_FLG,
		"" AS accountflg,
		j.ACCOUNT_FLG,
		j.PLAN_DALDAY,
		j.PLAN_SALE,
		t.REMARK,
		IFNULL( t.NEW_INPUT_NO, "" ) AS NEW_INPUT_NO,
		t.INPUT_NO,
		GROUP_CONCAT( lb.LABEL_TEXT ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lable,
		GROUP_CONCAT( lb.LABEL_ID ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lableid,
		GROUP_CONCAT( lb.LABEL_LEVEL ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lablelevel,
		t.TRAN_NAME,
		t.TRAN_STATUS,
		t.TRAN_AMT,
		t.ADD_DATE,
		IFNULL( t.CONFIRMDATE, "" ) AS CONFIRMDATE,
		t.ADD_USERCD,
		t.CONFIRMEMP,
		j.COMPANY_CD,
		j.PAYER_CD,
		t.ITEM_CODE
	FROM
	jobtrn j
	JOIN trantrn t ON j.JOB_CD = t.JOB_CD 
		AND j.COMPANY_CD = #{companycd}
		and t.COMPANY_CD = #{companycd}
		AND j.DEL_FLG = 0 
		AND t.DEL_FLG = 0
	LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = t.INPUT_NO 
		AND orderlabeltrn.COMPANY_CD = #{companycd} 
		AND orderlabeltrn.LABEL_LEVEL = 3
	LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID 
		AND lb.COMPANY_CD = #{companycd} 
		AND lb.LABEL_TYPE = 1 
		AND lb.DEL_FLG = 0 
		WHERE
		1 = 1 
		
		AND j.COMPANY_CD = #{companycd} 
		and t.COMPANY_CD = #{companycd}
		
		<if test="str!=null and str!=''">
		AND 
		(
			    t.TRAN_NAME LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	t.REMARK LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	t.JOB_CD LIKE CONCAT( '%',#{str}, '%' )
		 OR lb.LABEL_TEXT LIKE CONCAT( '%',#{str}, '%' ) 
		)
		</if>
			GROUP BY
			j.JOB_CD,
			t.NEW_INPUT_NO
			) AS j
		LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD 
		AND cl1.CLIENT_FLG = 1 
		AND cl1.COMPANY_CD = #{companycd}
		LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD 
		AND cl2.CONTRA_FLG = 1 
		AND cl2.COMPANY_CD = #{companycd}
		LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD 
		AND sellordertrn.DEL_FLG = 0 
		AND sellordertrn.COMPANY_CD = #{companycd}
		LEFT JOIN commonmst ON commonmst.MSTCD = "0003" 
		AND commonmst.ITEMCD = "003" 
		AND commonmst.COMPANY_CD = #{companycd}
		AND commonmst.DEL_FLG = 0
		LEFT JOIN commonmst co ON co.MSTCD = "9002" 
		AND co.ITEMCD = j.ITEM_CODE 
		AND co.COMPANY_CD = #{companycd} 
		AND co.DEL_FLG = 0
		LEFT JOIN salemst ON j.SALE_TYP = salemst.SALE_CD 
		AND salemst.COMPANY_CD = #{companycd}
		LEFT JOIN usermst tcfm ON tcfm.USERCD = j.CONFIRMEMP
		LEFT JOIN usermst tad ON tad.USERCD = j.ADD_USERCD
		LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD =#{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
	GROUP BY
	jobcd,
	inputno
		UNION ALL
	SELECT
		b.ITEMNAME_JP AS lendnamejp,
		b.ITEMNAME_EN AS lendnameen,
		b.ITEMNAME_HK AS lendnamezt,
		b.ITMNAME AS lendnamezc,
		j.JOB_CD AS jobcd,
		j.JOB_NAME AS jobName,
		j.CLDIV_CD AS cldivcd,
		j.SALE_TYP AS saletype,
		salemst.SALE_NAME AS salename,
		ifnull( sellordertrn.DLVDAY, j.PLAN_DALDAY ) AS dalday,
		sellordertrn.DLVDAY AS realDalday,
		"" AS jobendflg,
		j.JOBEND_FLG AS jobendflgcd,
		"" AS accountflg,
		j.ACCOUNT_FLG AS accountflgcd,
		IFNULL( sellordertrn.SALE_AMT, j.PLAN_SALE ) AS saleamt,
		commonmst.ITMNAME AS diszc,
		commonmst.ITEMNAME_EN AS disen,
		commonmst.ITEMNAME_HK AS diszt,
		commonmst.ITEMNAME_JP AS disjp,
		commonmst.ITEMCD AS discd,
		"" AS cost_no,
		IFNULL( j.NEW_INPUT_NO, "" ) AS inputno,
		j.INPUT_NO AS oldinputno,
		"" AS paycd,
		j.LEND_NAME AS `name`,
		"" AS statuszc,
		"" AS statusen,
		"" AS statusjp,
		"" AS statuszt,
		j.`STATUS` AS statuscd,
		j.LEND_AMT AS amt,
		j.LEND_VAT_AMT AS vatamt,
		j.LEND_PAY_AMT AS payamt,
		j.ADDDATE AS adddate,
		"" AS payreqdate,
		IFNULL( j.CONFIRMDATE, "" ) AS confirmdate,
		"" AS outputflgzc,
		"" AS outputflgen,
		"" AS outputflgjp,
		"" AS outputflgzt,
		"" AS outputflgcd,
		"" AS payflgzc,
		"" AS payflgen,
		"" AS payflgjp,
		"" AS payflgzt,
		"" AS payflgcd,
		"" AS paylockflg,
		"" AS invoicno,
		"" AS invoicedate,
		j.ADDUSERCD AS addusercd,
		lad.USER_NAME AS addusername,
		"" AS payreqemp,
		"" AS payreqempname,
		j.CONFIRMEMP AS confirmemp,
		lcfm.USER_NAME AS confirmempname,
		"" AS paydlyday,
		"" AS plandlvday,
		"" AS pay_hopedate,
		j.LEND_DATE AS lenddate,
		usermst.USER_NAME AS lenduser,
		j.LEND_NAME AS lendname,
		"" AS tranitemcode,
		"" AS tranitemnamezc,
		"" AS tranitemnameen,
		"" AS tranitemnamejp,
		"" AS tranitemnamezt,
		j.REMARK AS remark,
		"" AS costtype,
		"" AS paydate,
		"" AS planpaydate,
		IFNULL( j.lable, "" ) AS lable,
		IFNULL( j.lableid, "" ) AS lableid,
		IFNULL( j.lablelevel, "" ) AS lablelevel,
		j.COMPANY_CD AS companycd,
		cl1.DIVNM AS cldivname,
		cl1.DIVNAME_FULL AS cldivfullname,
		"" AS payeename,
		ifnull( cl2.DIVNAME_FULL, "" ) AS payeefullname,
		j.BL_FLG AS bl,
		adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd,
		"" AS payremark 
	FROM
	(
	SELECT
		GROUP_CONCAT( lb.LABEL_TEXT ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lable,
		GROUP_CONCAT( lb.LABEL_ID ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lableid,
		GROUP_CONCAT( lb.LABEL_LEVEL ORDER BY lb.LABEL_LEVEL DESC SEPARATOR ' ' ) AS lablelevel,
		j.JOB_CD,
		j.JOB_NAME,
		j.CLDIV_CD,
		j.SALE_TYP,
		j.JOBEND_FLG,
		j.ACCOUNT_FLG,
		j.PLAN_DALDAY,
		j.PLAN_SALE,
		j.COMPANY_CD,
		l.INPUT_NO,
		j.PAYER_CD,
		l.LEND_NAME,
		l.`STATUS`,
		l.LEND_AMT,
		l.ITEM_CODE,
		l.LEND_VAT_AMT ,
		l.LEND_PAY_AMT,
		l.ADDDATE,
		l.CONFIRMDATE,
		l.ADDUSERCD ,
		l.CONFIRMEMP ,
		l.LEND_DATE,
		l.REMARK,
		l.BL_FLG,
		l.NEW_INPUT_NO,
		l.LEND_USER
	FROM
		jobtrn j JOIN lendtrn l 
			ON l.JOB_CD = j.JOB_CD 
			AND l.COMPANY_CD =#{companycd} 
			AND l.DEL_FLG = 0
			AND j.COMPANY_CD = #{companycd}
			AND j.DEL_FLG = 0 
			LEFT JOIN orderlabeltrn ON orderlabeltrn.COST_NO = l.INPUT_NO 
			AND orderlabeltrn.COMPANY_CD = #{companycd} 
			AND orderlabeltrn.LABEL_LEVEL = 2
			LEFT JOIN labelmst AS lb ON lb.LABEL_ID = orderlabeltrn.LABEL_ID 
			AND lb.COMPANY_CD = #{companycd} 
			AND lb.LABEL_TYPE = 1 
			AND lb.DEL_FLG = 0 
			WHERE
			1=1 
			AND j.COMPANY_CD=#{companycd}
			AND l.COMPANY_CD =#{companycd}
			<if test="str!=null and str!=''">
		AND 
		(
				l.LEND_NAME	 LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	l.REMARK LIKE CONCAT( '%',#{str}, '%' ) 
		 OR 	l.JOB_CD LIKE CONCAT( '%',#{str}, '%' )
		 OR lb.LABEL_TEXT LIKE CONCAT( '%',#{str}, '%' ) 
		)
		</if>
		GROUP BY
			j.JOB_CD,
			l.INPUT_NO 
		) AS j
		LEFT JOIN commonmst b ON j.ITEM_CODE = b.ITEMCD 
		AND b.mstcd = '9001' 
		AND b.company_cd = #{companycd}
		LEFT JOIN clmst cl1 ON j.CLDIV_CD = cl1.CLDIVCD 
		AND cl1.COMPANY_CD =#{companycd} 
		AND cl1.CLIENT_FLG = 1
		LEFT JOIN clmst cl2 ON j.PAYER_CD = cl2.CLDIVCD 
		AND cl2.COMPANY_CD =#{companycd} 
		AND cl2.CONTRA_FLG = 1
		LEFT JOIN sellordertrn ON j.JOB_CD = sellordertrn.JOB_CD 
		AND sellordertrn.DEL_FLG = 0 
		AND sellordertrn.COMPANY_CD = #{companycd}
		LEFT JOIN commonmst ON commonmst.MSTCD = "0003" 
		AND commonmst.ITEMCD = "002" 
		AND commonmst.COMPANY_CD = #{companycd} 
		AND commonmst.DEL_FLG = 0
		LEFT JOIN salemst ON j.SALE_TYP = salemst.SALE_CD 
		AND salemst.COMPANY_CD = #{companycd}
		LEFT JOIN usermst ON j.LEND_USER = usermst.USERCD
		LEFT JOIN usermst lcfm ON lcfm.USERCD = j.CONFIRMEMP
		LEFT JOIN usermst lad ON lad.USERCD = j.ADDUSERCD
		LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd}
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD =#{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
	GROUP BY
		j.JOB_CD,
		j.INPUT_NO 
	) a 
ORDER BY
	a.dalday ASC,
	a.jobcd DESC,
	a.discd ASC,
	a.costno DESC,
	a.inputno DESC
	</select>
	<!-- 详细检索其他 -->
	<select id="getCostListByOther" resultType="com.kaiwait.bean.jczh.vo.CostListVo">
		<include refid="baseSql" />
		
		<if test="invoicno!='' and invoicno!=null">
		 and invoicno like CONCAT('%',#{invoicno},'%')  
		</if>
		<if test="invoicedate!=null and invoicedate!='' and invoicedate1!=null and invoicedate1!=''">
		  and invoicedate between #{invoicedate} and #{invoicedate1}
		</if>
		<if test="payhopedate!=null and payhopedate!=''">
		 and (payhopedate=#{payhopedate} or paydate=#{payhopedate} or planpaydate=#{payhopedate} )
		</if>
		<if test="payflg!='' and payflg!=null ">
		 <if test="payflg==001">
		 AND (payflgcd = 0 OR ISNULL(payflgcd))
		 AND DISCD  = "001"
		 </if>
		 <if test="payflg==002">
		 and payflgcd = 1
		 </if>
		</if>
		<if test="costtype!=null and costtype!=''">
		and costtype like CONCAT('%',#{costtype},'%') 
		</if>
	 order by a.dalday asc, a.jobcd desc ,a.discd asc,a.costno desc,a.inputno desc
	</select>
	
	<select id="getCostListFromTop" resultType="com.kaiwait.bean.jczh.vo.CostListVo">
	<include refid="baseSql" />
	
	   <if test="ad == '0'.toString()">
	   <if test="checkDate!=null">
		and a.confirmdate >=  #{checkDate}
		</if>
		  and a.confirmdate IS NOT NULL and a.confirmdate!=''
	   </if>
	   <if test="ad == '1'.toString()">
 		and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "002" and a.statuscd = 0) or ( a.discd = "003" and a.statuscd = 0) or (a.discd = "001" AND a.statuscd = 1 and (SELECT PAY_SKIP from companymst where company_cd= #{companycd})=1))
	   </if>
	   
	   <if test="ad == '2'.toString()">
	    and a.discd = "001" and a.statuscd = 2
	   </if>
	   <if test="ad == '3'.toString()">
	   and a.discd = "002" and a.bl = 1 and a.statuscd != 1 and a.statuscd != 3
	   </if>
	   <if test="ad == '4'.toString()">
	   and a.discd = "003" and a.statuscd = 0
	   and date_format(a.realDalday,"%Y%m") = (select DATE_FORMAT(ITMVALUE,"%Y%m") from commonmst where commonmst.MSTCD = "0001" and commonmst.COMPANY_CD = #{companycd})
	   </if>
	   <!-- 财务部门初始化  查询支払申請済、立替登録済、振替登録済（承認待ち） -->
	    <if test="ad == 'Finance'">
	    and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "002" and a.statuscd = 0) or ( a.discd = "003" and a.statuscd = 0))
	   </if>
	   <!-- トラフィック部门初始化  查询支払登録済（申請待ち） -->
	    <if test="ad == 'Traffic'">
	    and a.discd = "001" and a.statuscd = 1
	   </if>
	 	<if test="dalday==null or dalday==''">
		   <if test=" dalday1!=null and dalday1!=''">
		   	and a.dalday  &lt;= #{dalday1}
		   </if>
		</if>
	   <!-- 不是以上情况就是 从job一览跳过来根据jobcd 查询 -->
	   <if test="ad!=null and ad !=''  and ad!='0'.toString() and ad!='1'.toString() and ad!='2'.toString() and ad!='3'.toString() and ad!='4'.toString() and ad!='Finance' and ad!='Traffic' ">
	    and a.jobcd = #{ad}
	   </if>
	   order by a.dalday asc, a.jobcd desc ,a.discd asc,a.costno desc,a.inputno desc
	</select>
	<!-- 查询checkdata -->
	<select id="selectCheckDate" resultType="String">
	   select CHECK_DATE from summary where COMPANY_CD = #{companycd} and ACCOUNTYM=#{stt}
	</select>
	<!-- 支付处理 -->
	<update id="insertPaytrnByInum" >
	   update  paytrn 
	    <set>   
	     PAY_DATE=  #{paydate},
	     PAY_FLG =  #{payflg},
	     PAY_UP_DATE = #{upDateDate},
	     PAY_UP_USERCD = #{upUsercd},
	     LOCK_FLG = #{paylockflg}
	    <if test ="payremark!=null and payremark!=''">
	      , PAY_REMARK =#{payremark},
	    </if>
	    </set>
	    where 
	     INPUT_NO = #{inputno}
	    and COMPANY_CD = #{companycd}
	</update>
	<select id="getcostCount" resultType="int">
	 SELECT 
		count(*)
	FROM
		(
		SELECT JOB_CD FROM costtrn WHERE COMPANY_CD=#{companycd} AND DEL_FLG=0
		UNION ALL
		SELECT JOB_CD FROM lendtrn WHERE COMPANY_CD=#{companycd} AND DEL_FLG =0
		UNION ALL
		SELECT JOB_CD FROM trantrn WHERE COMPANY_CD =#{companycd} AND  DEL_FLG =0
		)  AS costCount
	</select>
	

<select id="getTopAdCount" resultType="int">
SELECT
	COUNT( * ) 
FROM
	(
SELECT
	j.JOB_CD AS jobcd,
	IFNULL( p.CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	c.`STATUS` AS statuscd,
	j.CLDIV_CD AS cldivcd,
			adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
	jobtrn AS j
		JOIN costtrn AS c ON j.JOB_CD = c.JOB_CD AND c.DEL_FLG = 0 AND c.COMPANY_CD = #{companycd}
left join paytrn as p on c.INPUT_NO = p.INPUT_NO and p.DEL_FLG = 0 and p.COMPANY_CD = #{companycd}
left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "001" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
c.DEL_FLG=0 
AND c.COMPANY_CD=#{companycd}
group by j.JOB_CD,c.COST_NO
<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
</if>


	UNION  ALL
	SELECT
	j.JOB_CD AS jobcd,
	IFNULL( t.CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	t.TRAN_STATUS AS statuscd,
	j.CLDIV_CD AS cldivcd,			
	adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
		jobtrn j
		JOIN trantrn t ON j.JOB_CD = t.JOB_CD 
		AND t.COMPANY_CD = #{companycd} 
		AND j.DEL_FLG = 0 
		AND t.DEL_FLG = 0
LEFT JOIN commonmst ON commonmst.MSTCD = "0003" 
		AND commonmst.ITEMCD = "003" 
		AND commonmst.COMPANY_CD = #{companycd}
		AND commonmst.DEL_FLG = 0
		LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
t.DEL_FLG=0 
AND t.COMPANY_CD=#{companycd}
GROUP BY
	j.JOB_CD,
	t.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
	
	UNION  ALL
	SELECT 
	j.JOB_CD AS jobcd,
	IFNULL( CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	l.`STATUS` AS statuscd,
	j.CLDIV_CD AS cldivcd,
				adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
jobtrn j
	JOIN lendtrn l ON l.JOB_CD = j.JOB_CD AND l.COMPANY_CD =#{companycd} AND l.DEL_FLG = 0
 left join commonmst on commonmst.MSTCD = "0003" 
 and commonmst.ITEMCD= "002" and  commonmst.COMPANY_CD  =#{companycd} and commonmst.DEL_FLG = 0
 LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
l.DEL_FLG=0 AND l.COMPANY_CD = #{companycd}
GROUP BY
	j.JOB_CD,
	l.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
	) a 
WHERE
	1 = 1 
  <if test="all==null or all==''">
  and (
  	<trim prefixOverrides="and |or">
   <if test="cldivUser!=null or cldivUser!=''">
      a.cldivcd in (
        	select ucl.cldivcd 
			from userclmst ucl 
			where ucl.user_cd =#{cldivUser}
			and ucl.company_cd=#{companycd}
      )
   </if>
   <if test="adUser!=null or adUser!=''">
      or a.adusercd = #{adUser} or a.requsercd = #{adUser}
   </if>
    <if test="mdUser!=null or mdUser!=''">
      or a.mdusercd = #{mdUser} 
   </if>
   </trim >
  )
  </if>
<if test="ad == '0'.toString()">
	   <if test="checkDate!=null">
		and a.confirmdate >=  #{checkDate}
		</if>
		  and a.confirmdate IS NOT NULL and a.confirmdate!=''
	   </if>
	   <if test="ad == '1'.toString()">
 		and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "002" and a.statuscd = 0) or ( a.discd = "003" and a.statuscd = 0) or (a.discd = "001" AND a.statuscd = 1 and (SELECT PAY_SKIP from companymst where company_cd= #{companycd})=1))
	   </if>
	   
	   <if test="ad == '2'.toString()">
	    and a.discd = "001" and a.statuscd = 2
	   </if>
	   <if test="ad == '3'.toString()">
	   and a.discd = "002" and a.bl = 1 and a.statuscd != 1 and a.statuscd != 3
	   </if>
	   <if test="ad == '4'.toString()">
	   and a.discd = "003" and a.statuscd = 0
	   and date_format(a.realDalday,"%Y%m") = (select DATE_FORMAT(ITMVALUE,"%Y%m") from commonmst where commonmst.MSTCD = "0001" and commonmst.COMPANY_CD = #{companycd})
	   </if>
	   <!-- 财务部门初始化  查询支払申請済、立替登録済、振替登録済（承認待ち） -->
	    <if test="ad == 'Finance'">
	    and ((a.discd = "001" and a.statuscd = 2) or (a.discd = "002" and a.statuscd = 0) or ( a.discd = "003" and a.statuscd = 0))
	   </if>
	   <!-- トラフィック部门初始化  查询支払登録済（申請待ち） -->
	    <if test="ad == 'Traffic'">
	    and a.discd = "001" and a.statuscd = 1
	   </if>
	    <if test="status==001">
		       and ((a.discd = "001" and a.statuscd != 4) or ( a.discd = "002" and a.statuscd != 3) or ( a.discd = "003" and a.statuscd != 2))
		</if>
	</select>
	
	
	<select id="getTopProgressCount"  resultType="com.kaiwait.bean.jczh.vo.CostListVo">
SELECT
		a.jobcd AS jobcd,
		IFNULL( a.confirmdate, "" ) AS confirmdate,
		a.discd AS discd,
		a.statuscd AS statuscd,
		a.cldivcd AS cldivcd,
		a.adusercd AS adusercd,
		ifnull( a.requsercd, "" ) AS requsercd,
		IFNULL( a.mdusercd, "" ) AS mdusercd,
		(SELECT PAY_SKIP FROM companymst WHERE company_cd = #{companycd}) AS paySkip 
FROM
	(
SELECT
	j.JOB_CD AS jobcd,
	IFNULL( p.CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	c.`STATUS` AS statuscd,
	j.CLDIV_CD AS cldivcd,
			adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
	jobtrn AS j
		JOIN costtrn AS c ON j.JOB_CD = c.JOB_CD AND c.DEL_FLG = 0 AND c.COMPANY_CD = #{companycd}
left join paytrn as p on c.INPUT_NO = p.INPUT_NO and p.DEL_FLG = 0 and p.COMPANY_CD = #{companycd}
left join commonmst on commonmst.MSTCD = "0003" and commonmst.ITEMCD= "001" and  commonmst.COMPANY_CD  = #{companycd} and commonmst.DEL_FLG = 0
LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
c.DEL_FLG=0 
AND c.COMPANY_CD=#{companycd}
group by j.JOB_CD,c.COST_NO
<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
</if>


	UNION  ALL
	SELECT
	j.JOB_CD AS jobcd,
	IFNULL( t.CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	t.TRAN_STATUS AS statuscd,
	j.CLDIV_CD AS cldivcd,			
	adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
		jobtrn j
		JOIN trantrn t ON j.JOB_CD = t.JOB_CD 
		AND t.COMPANY_CD = #{companycd} 
		AND j.DEL_FLG = 0 
		AND t.DEL_FLG = 0
LEFT JOIN commonmst ON commonmst.MSTCD = "0003" 
		AND commonmst.ITEMCD = "003" 
		AND commonmst.COMPANY_CD = #{companycd}
		AND commonmst.DEL_FLG = 0
		LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
t.DEL_FLG=0 
AND t.COMPANY_CD=#{companycd}
GROUP BY
	j.JOB_CD,
	t.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
	
	UNION  ALL
	SELECT 
	j.JOB_CD AS jobcd,
	IFNULL( CONFIRMDATE, "" ) AS confirmdate,
	commonmst.ITEMCD AS discd,
	l.`STATUS` AS statuscd,
	j.CLDIV_CD AS cldivcd,
				adMst.USERCD AS adusercd,
		ifnull( reqMst.USERCD, "" ) AS requsercd,
		IFNULL( mdMst.USERCD, "" ) AS mdusercd
FROM
jobtrn j
	JOIN lendtrn l ON l.JOB_CD = j.JOB_CD AND l.COMPANY_CD =#{companycd} AND l.DEL_FLG = 0
 left join commonmst on commonmst.MSTCD = "0003" 
 and commonmst.ITEMCD= "002" and  commonmst.COMPANY_CD  =#{companycd} and commonmst.DEL_FLG = 0
 LEFT JOIN jobuserstrn jobAduser ON j.JOB_CD = jobAduser.JOB_CD 
		AND jobAduser.LEVEL_FLG = '1' 
		AND jobAduser.COMPANY_CD = #{companycd} 
		AND jobAduser.DEL_FLG = 0
		LEFT JOIN usermst adMst ON adMst.USERCD = jobAduser.USERCD
		LEFT JOIN jobuserstrn jobRequser ON j.JOB_CD = jobRequser.JOB_CD 
		AND jobRequser.LEVEL_FLG = '2' 
		AND jobRequser.COMPANY_CD = #{companycd} 
		AND jobRequser.DEL_FLG = 0
		LEFT JOIN usermst reqMst ON reqMst.USERCD = jobRequser.USERCD
		LEFT JOIN jobuserstrn jobMduser ON j.JOB_CD = jobMduser.JOB_CD 
		AND jobMduser.LEVEL_FLG = '3' 
		AND jobMduser.COMPANY_CD = #{companycd} 
		AND jobMduser.DEL_FLG = 0
		LEFT JOIN usermst mdMst ON mdMst.USERCD = jobMduser.USERCD
WHERE
l.DEL_FLG=0 AND l.COMPANY_CD = #{companycd}
GROUP BY
	j.JOB_CD,
	l.INPUT_NO
	<if test="(all==null or all=='') and (cldivUser==null or cldivUser=='')">
		,mdMst.USERCD
	</if>
	) a 
where 1=1
  <if test="all==null or all==''">
  and (
  	<trim prefixOverrides="and |or">
   <if test="cldivUser!=null or cldivUser!=''">
      a.cldivcd in (
        	select ucl.cldivcd 
			from userclmst ucl 
			where ucl.user_cd =#{cldivUser}
			and ucl.company_cd=#{companycd}
      )
   </if>
   <if test="adUser!=null or adUser!=''">
      or a.adusercd = #{adUser} or a.requsercd = #{adUser}
   </if>
    <if test="mdUser!=null or mdUser!=''">
      or a.mdusercd = #{mdUser} 
   </if>
   </trim >
  )
  </if> 
	    <if test="status==001">
		       and ((a.discd = "001" and a.statuscd != 4) or ( a.discd = "002" and a.statuscd != 3) or ( a.discd = "003" and a.statuscd != 2))
		</if>
		</select>
</mapper>